<?php
/**
 * ููู ูุญุต ุงููุณุงุฑ ูุงูุฅุตูุงุญ ุงูุณุฑูุน
 */

header('Content-Type: text/html; charset=utf-8');

echo "<h2>๐ ูุญุต ุงููุณุงุฑ ูุฅุตูุงุญ ุณุฑูุน</h2>";

echo "<div style='background: #f0f8ff; padding: 15px; margin: 10px 0; border-radius: 8px;'>";
echo "<h3>๐ ูุนูููุงุช ุงููุณุงุฑ ุงูุญุงูู:</h3>";
echo "<p><strong>ุงููุณุงุฑ ุงููุงูู:</strong> " . __DIR__ . "</p>";
echo "<p><strong>ุงุณู ุงูููู:</strong> " . basename(__FILE__) . "</p>";
echo "<p><strong>URL ุงูููุงุณุจ:</strong> http://localhost" . str_replace($_SERVER['DOCUMENT_ROOT'], '', __DIR__) . "/" . basename(__FILE__) . "</p>";
echo "</div>";

// ูุญุงููุฉ ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช
try {
    // ุชุฌุฑุจุฉ ุงุชุตุงู ูุจุณุท
    $conn = new PDO("mysql:host=localhost;dbname=shahad_clean_db;charset=utf8mb4", "root", "");
    $conn->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    
    echo "<div style='background: #e8f5e8; padding: 15px; margin: 10px 0; border-radius: 8px;'>";
    echo "<h3>โ ุงุชุตุงู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุงุฌุญ</h3>";
    
    // ูุญุต ุณุฑูุน ูููุณุชุฎุฏููู
    $stmt = $conn->query('SELECT COUNT(*) as count FROM users');
    $userCount = $stmt->fetch()['count'];
    echo "<p>ุนุฏุฏ ุงููุณุชุฎุฏููู: <strong>$userCount</strong></p>";
    
    // ูุญุต ุณุฑูุน ููุทูุจุงุช
    $stmt = $conn->query('SELECT COUNT(*) as count FROM requests');
    $requestCount = $stmt->fetch()['count'];
    echo "<p>ุนุฏุฏ ุงูุทูุจุงุช: <strong>$requestCount</strong></p>";
    
    // ุฅุถุงูุฉ ูุณุชุฎุฏููู ุงุฎุชุจุงุฑููู ุณุฑูุนุงู
    echo "<h4>๐ง ุฅุถุงูุฉ ุจูุงูุงุช ุงุฎุชุจุงุฑูุฉ ุณุฑูุนุฉ:</h4>";
    
    // ุชุญุฏูุซ/ุฅุถุงูุฉ ูุณุชุฎุฏููู
    $users = [
        ['id' => 1, 'username' => 'ahmed.salem', 'full_name' => 'ุฃุญูุฏ ุณุงูู ุงููุทูุฑู', 'email' => 'ahmed@test.com'],
        ['id' => 2, 'username' => 'sara.mohammed', 'full_name' => 'ุณุงุฑุฉ ูุญูุฏ ุงูุฃุญูุฏ', 'email' => 'sara@test.com'],
        ['id' => 3, 'username' => 'omar.abdullah', 'full_name' => 'ุนูุฑ ุนุจุฏุงููู ุงูุฎุงูุฏ', 'email' => 'omar@test.com']
    ];
    
    foreach ($users as $user) {
        try {
            // ูุญุงููุฉ ุชุญุฏูุซ ุฃู ุฅุฏุฑุงุฌ
            $stmt = $conn->prepare('INSERT INTO users (id, username, full_name, email, password) VALUES (?, ?, ?, ?, ?) ON DUPLICATE KEY UPDATE full_name = VALUES(full_name), email = VALUES(email)');
            $stmt->execute([$user['id'], $user['username'], $user['full_name'], $user['email'], password_hash('123456', PASSWORD_DEFAULT)]);
            echo "โ ุชู ุชุญุฏูุซ/ุฅุถุงูุฉ: {$user['full_name']}<br>";
        } catch (Exception $e) {
            echo "โ๏ธ ุฎุทุฃ ูู {$user['full_name']}: " . $e->getMessage() . "<br>";
        }
    }
    
    // ุชุญุฏูุซ ุจุนุถ ุงูุทูุจุงุช
    echo "<h4>๐ง ุชุญุฏูุซ ุงูุทูุจุงุช:</h4>";
    
    $requestUpdates = [
        ['id' => 1, 'user_id' => 1, 'request_type' => 'electricity', 'subject' => 'ุฅุตูุงุญ ุนุทู ููุฑุจุงุฆู'],
        ['id' => 2, 'user_id' => 2, 'request_type' => 'plumbing', 'subject' => 'ุตูุงูุฉ ุชุณุฑูุจ ููุงู'],
        ['id' => 3, 'user_id' => 3, 'request_type' => 'ac', 'subject' => 'ุตูุงูุฉ ูููู ุงูููุงุก']
    ];
    
    foreach ($requestUpdates as $update) {
        try {
            $stmt = $conn->prepare('UPDATE requests SET user_id = ?, request_type = ?, subject = ? WHERE id = ?');
            $stmt->execute([$update['user_id'], $update['request_type'], $update['subject'], $update['id']]);
            echo "โ ุชู ุชุญุฏูุซ ุงูุทูุจ #{$update['id']}<br>";
        } catch (Exception $e) {
            echo "โ๏ธ ุฎุทุฃ ูู ุงูุทูุจ #{$update['id']}: " . $e->getMessage() . "<br>";
        }
    }
    
    // ุนุฑุถ ุงููุชูุฌุฉ
    echo "<h4>๐ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ:</h4>";
    $stmt = $conn->query('
        SELECT r.id, r.subject, r.request_type, 
               u.full_name as user_name, u.username 
        FROM requests r 
        LEFT JOIN users u ON r.user_id = u.id 
        ORDER BY r.id DESC 
        LIMIT 5
    ');
    
    echo "<table border='1' style='border-collapse: collapse; width: 100%; margin: 10px 0;'>";
    echo "<tr style='background: #f0f8ff;'><th>ID</th><th>ุงุณู ุงููุณุชุฎุฏู</th><th>ููุน ุงูุทูุจ</th><th>ุงูููุถูุน</th></tr>";
    
    while ($row = $stmt->fetch()) {
        echo "<tr>";
        echo "<td>#{$row['id']}</td>";
        echo "<td><strong style='color: #2c5aa0;'>{$row['user_name']}</strong></td>";
        echo "<td>{$row['request_type']}</td>";
        echo "<td>{$row['subject']}</td>";
        echo "</tr>";
    }
    echo "</table>";
    
    echo "</div>";
    
    echo "<div style='background: #fff3cd; padding: 15px; margin: 10px 0; border-radius: 8px;'>";
    echo "<h3>๐ฏ ุงูุฎุทูุงุช ุงูุชุงููุฉ:</h3>";
    echo "<ol>";
    echo "<li><a href='admin.html' target='_blank'>ุงุฐูุจ ุฅูู ุตูุญุฉ ุงูุฅุฏุงุฑุฉ</a></li>";
    echo "<li>ุณุฌู ุฏุฎูู ุจู: <code>admin</code> / <code>admin123</code></li>";
    echo "<li>ุงูุชูู ุฅูู ูุณู 'ุฅุฏุงุฑุฉ ุงูุทูุจุงุช'</li>";
    echo "<li>ุณุชุฌุฏ ุงูุฃุณูุงุก ุงูุญููููุฉ ุจุฏูุงู ูู 'ูุฏูุฑ ุงูุนุงู'</li>";
    echo "</ol>";
    echo "</div>";
    
} catch (Exception $e) {
    echo "<div style='background: #f8d7da; padding: 15px; margin: 10px 0; border-radius: 8px;'>";
    echo "<h3>โ ุฎุทุฃ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:</h3>";
    echo "<p>" . $e->getMessage() . "</p>";
    echo "<p><strong>ุชุฃูุฏ ูู:</strong></p>";
    echo "<ul>";
    echo "<li>ุชุดุบูู XAMPP</li>";
    echo "<li>ุชุดุบูู MySQL</li>";
    echo "<li>ูุฌูุฏ ูุงุนุฏุฉ ุงูุจูุงูุงุช: shahad_clean_db</li>";
    echo "</ul>";
    echo "</div>";
}
?>